// ============================================
// BLOQUE MEJORADO: Generación de Consecutivos sin Duplicados
// ============================================
// Reemplaza las líneas 295-361 en routes/pedidos.js

// Obtener/generar NUMERO desde tabla CONSECUTIVO por CODCOMP+CODPREFIJO+SUCID
let numeroVal = (numero !== undefined && numero !== null && String(numero).trim() !== '') ? String(numero).trim() : null;
let siguienteDesdeConsecutivo = null;
const sucidVal = sucid || 1;

// Si el cliente NO envía número, generar automáticamente
if (!numeroVal) {
    // Paso 1: Intentar obtener y bloquear fila en CONSECUTIVO (SELECT FOR UPDATE)
    try {
        const consRows = await executeQueryInTransaction(
            transaction,
            'SELECT FIRST 1 CONSECUTIVO FROM CONSECUTIVO WHERE CODCOMP = ? AND CODPREFIJO = ? AND SUCID = ? FOR UPDATE WITH LOCK',
            [codcompVal, codprefijoVal, sucidVal]
        );
        
        if (consRows && consRows[0] && consRows[0].CONSECUTIVO !== undefined) {
            // Existe fila: leer y calcular siguiente
            const lastNum = parseInt(String(consRows[0].CONSECUTIVO || '').replace(/\D/g, ''), 10) || 0;
            siguienteDesdeConsecutivo = lastNum + 1;
        } else {
            // No existe fila: crear una nueva con valor inicial
            // Primero buscar el máximo en KARDEX para inicializar correctamente
            const maxNumRows = await executeQueryInTransaction(
                transaction,
                `SELECT COALESCE(MAX(CAST(NUMERO AS INTEGER)), 0) AS MAXNUM
                 FROM KARDEX
                 WHERE CODCOMP = ? AND CODPREFIJO = ? AND NUMERO SIMILAR TO '[0-9]+'`,
                [codcompVal, codprefijoVal]
            );
            const maxNum = Number(maxNumRows && maxNumRows[0] && maxNumRows[0].MAXNUM) || 0;
            siguienteDesdeConsecutivo = maxNum + 1;
            
            // Insertar nueva fila en CONSECUTIVO
            try {
                await executeQueryInTransaction(
                    transaction,
                    'INSERT INTO CONSECUTIVO (CODCOMP, CODPREFIJO, SUCID, CONSECUTIVO) VALUES (?, ?, ?, ?)',
                    [codcompVal, codprefijoVal, sucidVal, siguienteDesdeConsecutivo]
                );
            } catch (insertErr) {
                // Si falla el INSERT (ej: ya existe por condición de carrera), intentar leer de nuevo
                const consRowsRetry = await executeQueryInTransaction(
                    transaction,
                    'SELECT FIRST 1 CONSECUTIVO FROM CONSECUTIVO WHERE CODCOMP = ? AND CODPREFIJO = ? AND SUCID = ? FOR UPDATE WITH LOCK',
                    [codcompVal, codprefijoVal, sucidVal]
                );
                if (consRowsRetry && consRowsRetry[0] && consRowsRetry[0].CONSECUTIVO !== undefined) {
                    const lastNumRetry = parseInt(String(consRowsRetry[0].CONSECUTIVO || '').replace(/\D/g, ''), 10) || 0;
                    siguienteDesdeConsecutivo = lastNumRetry + 1;
                }
            }
        }
        
        // Actualizar CONSECUTIVO INMEDIATAMENTE después de leer (antes de insertar KARDEX)
        if (siguienteDesdeConsecutivo !== null) {
            await executeQueryInTransaction(
                transaction,
                'UPDATE CONSECUTIVO SET CONSECUTIVO = ? WHERE CODCOMP = ? AND CODPREFIJO = ? AND SUCID = ?',
                [siguienteDesdeConsecutivo, codcompVal, codprefijoVal, sucidVal]
            );
            numeroVal = String(siguienteDesdeConsecutivo).padStart(8, '0');
        }
    } catch (consErr) {
        // Si falla todo, usar fallback a máximo de KARDEX
        console.warn('Error al leer CONSECUTIVO, usando fallback:', consErr.message);
        const maxNumRows = await executeQueryInTransaction(
            transaction,
            `SELECT COALESCE(MAX(CAST(NUMERO AS INTEGER)), 0) AS MAXNUM
             FROM KARDEX
             WHERE CODCOMP = ? AND CODPREFIJO = ? AND NUMERO SIMILAR TO '[0-9]+'`,
            [codcompVal, codprefijoVal]
        );
        const maxNum = Number(maxNumRows && maxNumRows[0] && maxNumRows[0].MAXNUM) || 0;
        const siguiente = maxNum + 1;
        numeroVal = String(siguiente).padStart(8, '0');
    }
}

// Si el cliente SÍ envía número, validar que no esté duplicado
if (numeroVal && (numero !== undefined && numero !== null && String(numero).trim() !== '')) {
    // Validar formato (máximo 8 caracteres)
    if (String(numeroVal).length > 8) {
        throw new Error(`El número enviado (${numeroVal}) excede 8 caracteres`);
    }
    
    // Validar que no esté duplicado
    const dupRows = await executeQueryInTransaction(
        transaction,
        'SELECT COUNT(*) AS TOTAL FROM KARDEX WHERE CODCOMP = ? AND CODPREFIJO = ? AND NUMERO = ?',
        [codcompVal, codprefijoVal, numeroVal]
    );
    
    if (Number(dupRows && dupRows[0] && dupRows[0].TOTAL) > 0) {
        // Si está duplicado, buscar el siguiente disponible
        const maxNumRows = await executeQueryInTransaction(
            transaction,
            `SELECT COALESCE(MAX(CAST(NUMERO AS INTEGER)), 0) AS MAXNUM
             FROM KARDEX
             WHERE CODCOMP = ? AND CODPREFIJO = ? AND NUMERO SIMILAR TO '[0-9]+'`,
            [codcompVal, codprefijoVal]
        );
        const maxNum = Number(maxNumRows && maxNumRows[0] && maxNumRows[0].MAXNUM) || 0;
        const siguiente = maxNum + 1;
        numeroVal = String(siguiente).padStart(8, '0');
        
        // Actualizar CONSECUTIVO si existe
        try {
            await executeQueryInTransaction(
                transaction,
                'UPDATE CONSECUTIVO SET CONSECUTIVO = ? WHERE CODCOMP = ? AND CODPREFIJO = ? AND SUCID = ?',
                [siguiente, codcompVal, codprefijoVal, sucidVal]
            );
        } catch (_) {}
    }
}

// Validación final de no duplicidad (última verificación antes de insertar)
const dupCheck = await executeQueryInTransaction(
    transaction,
    'SELECT COUNT(*) AS TOTAL FROM KARDEX WHERE CODCOMP = ? AND CODPREFIJO = ? AND NUMERO = ?',
    [codcompVal, codprefijoVal, numeroVal]
);

if (Number(dupCheck && dupCheck[0] && dupCheck[0].TOTAL) > 0) {
    // Si aún hay duplicado, buscar el siguiente disponible y actualizar CONSECUTIVO
    const maxNumRows = await executeQueryInTransaction(
        transaction,
        `SELECT COALESCE(MAX(CAST(NUMERO AS INTEGER)), 0) AS MAXNUM
         FROM KARDEX
         WHERE CODCOMP = ? AND CODPREFIJO = ? AND NUMERO SIMILAR TO '[0-9]+'`,
        [codcompVal, codprefijoVal]
    );
    const maxNum = Number(maxNumRows && maxNumRows[0] && maxNumRows[0].MAXNUM) || 0;
    const siguiente = maxNum + 1;
    numeroVal = String(siguiente).padStart(8, '0');
    
    // Actualizar CONSECUTIVO
    try {
        await executeQueryInTransaction(
            transaction,
            'UPDATE CONSECUTIVO SET CONSECUTIVO = ? WHERE CODCOMP = ? AND CODPREFIJO = ? AND SUCID = ?',
            [siguiente, codcompVal, codprefijoVal, sucidVal]
        );
    } catch (_) {}
}

// Asegurar que numeroVal tenga el formato correcto (8 dígitos con ceros a la izquierda)
numeroVal = String(numeroVal).padStart(8, '0');

// ============================================
// FIN DEL BLOQUE MEJORADO
// ============================================
// Después de este bloque, continúa con la inserción del pedido (línea 363+)

